<section class="perf-header">
    <h2>Trading Performance</h2>

    <div class="actions">
        <button class="btn" (click)="openManualTrade()">Add Trade</button>
        <button class="btn" (click)="refreshNow()">Refresh</button>
        <button class="btn btn-danger" (click)="clearAll()">Clear All</button>
    </div>
</section>

<!-- Realized-performance summary cards -->
<section class="cards" *ngIf="metrics$ | async as m">
    <div class="card">
        <div class="card-title">Total P&L (Realized)</div>
        <div class="card-value">{{ m.totalPnL | currency:'USD':'symbol':'1.2-2' }}</div>
    </div>

    <div class="card">
        <div class="card-title">Win Rate</div>
        <div class="card-value">{{ m.winRate / 100 | percent:'1.0-1' }}</div>
    </div>

    <div class="card">
        <div class="card-title">Avg Win</div>
        <div class="card-value">{{ m.averageWin | currency:'USD':'symbol':'1.2-2' }}</div>
    </div>

    <div class="card">
        <div class="card-title">Avg Loss</div>
        <div class="card-value">{{ -m.averageLoss | currency:'USD':'symbol':'1.2-2' }}</div>
    </div>

    <div class="card">
        <div class="card-title">Profit Factor</div>
        <div class="card-value">{{ m.profitFactor | number:'1.2-2' }}</div>
    </div>

    <div class="card">
        <div class="card-title">Max Drawdown</div>
        <div class="card-value">{{ m.maxDrawdown | currency:'USD':'symbol':'1.2-2' }}</div>
    </div>
</section>


<section class="panel">
    <div class="panel-title">Active Positions</div>

    <ng-container *ngIf="positions$ | async as positions; else noPos">
        <table class="tbl" *ngIf="positions.length; else noPos">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Qty</th>
                    <th>Avg Price</th>
                    <th>Last</th>
                    <th>Cost Basis</th>
                    <th>Market Value</th>
                    <th>P/L</th>
                    <th>P/L %</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let p of positions">
                    <td class="sym">{{ p.symbol }}</td>
                    <td>{{ p.quantity | number:'1.0-4' }}</td>
                    <td>{{ p.entryPrice | currency:'USD':'symbol':'1.2-2' }}</td>
                    <td>{{ p.currentPrice | currency:'USD':'symbol':'1.2-2' }}</td>
                    <td>{{ (p.entryPrice * p.quantity) | currency:'USD':'symbol':'1.2-2' }}</td>
                    <td>{{ ((p.currentPrice ?? 0) * p.quantity) | currency:'USD':'symbol':'1.2-2' }}</td>
                    <td [class.pos]="(p.unrealizedPnL ?? 0) >= 0" [class.neg]="(p.unrealizedPnL ?? 0) < 0">
                        {{ p.unrealizedPnL | currency:'USD':'symbol':'1.2-2' }}
                    </td>
                    <td [class.pos]="(p.unrealizedPnL ?? 0) >= 0" [class.neg]="(p.unrealizedPnL ?? 0) < 0">
                        {{ (p.unrealizedPnLPercent ?? 0) / 100 | percent:'1.1-2' }}
                    </td>
                </tr>

            </tbody>
        </table>
    </ng-container>

    <ng-template #noPos>
        <div class="empty">No active positions</div>
    </ng-template>
</section>

<!-- Trade Entry Modal -->
<app-trade-entry-modal *ngIf="showTradeModal" [symbol]="modalSymbol" (cancel)="cancelManualTrade()"
    (save)="saveManualTrade($event)">
</app-trade-entry-modal>

<app-close-position-modal *ngIf="showCloseModal" [symbol]="closeSymbol || ''" (cancel)="cancelCloseModal()"
    (save)="saveCloseModal($event)">
</app-close-position-modal>