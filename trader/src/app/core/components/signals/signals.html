<!-- Header with toolbar -->
<header class="lc-header" [style.--pill-active-bg]="activePillColor" [style.--pill-active-fg]="pillActiveFg"
    [style.--pill-active-border]="pillActiveBorder">
    <div class="toolbar">
        <!-- REPLACE this button with the one below -->
        <button class="pill" (click)="selectNone()" [class.active]="!selected()">
        </button>

        <!-- Symbol selection buttons (unchanged) -->
        @for (s of symbols; track s) {
        <label class="sym" (click)="selectSymbol(s)">
            <input type="radio" name="symbol" class="sr-only" [checked]="selected() === s" />
            <span [class.active]="selected() === s">{{ s }}</span>
        </label>
        }
    </div>
</header>


<!-- Chart Section - CHANGED TO CONTAINED -->
<section class="lc-canvas-wrap contained">
    <!-- Symbol display in corner (outside SVG for better visibility) -->
    @if (selected(); as sym) {
    <div class="corner-symbol">{{ sym }}</div>
    }

    <!-- Chart info panel -->
    @if (chartInfo(); as info) {
    <div class="chart-info-panel">
        <div class="info-symbol">{{ info.symbol }}</div>
        <div class="info-price" [class.positive]="info.priceChange >= 0" [class.negative]="info.priceChange < 0">
            ${{ info.currentPrice | number:'1.2-2' }}
            <span class="price-change">
                {{ info.priceChange >= 0 ? '+' : '' }}{{ info.priceChange | number:'1.2-2' }}
                ({{ info.priceChangePercent >= 0 ? '+' : '' }}{{ info.priceChangePercent | number:'1.2-2' }}%)
            </span>
        </div>
        <div class="info-stats">
            <div class="stat">
                <span class="stat-label">High</span>
                <span class="stat-value">${{ info.high | number:'1.2-2' }}</span>
            </div>
            <div class="stat">
                <span class="stat-label">Low</span>
                <span class="stat-value">${{ info.low | number:'1.2-2' }}</span>
            </div>
            <div class="stat">
                <span class="stat-label">Open</span>
                <span class="stat-value">${{ info.open | number:'1.2-2' }}</span>
            </div>
        </div>
    </div>
    }

    <!-- SVG Chart -->
    <svg class="lc-chart" [attr.viewBox]="'0 0 ' + viewW + ' ' + viewH" [attr.width]="'100%'"
        [attr.height]="chartHeight">

        <!-- Chart frame with visible border -->
        <rect [attr.x]="padLeft" [attr.y]="padTop" [attr.width]="viewW - padLeft - padRight"
            [attr.height]="viewH - padTop - padBottom" class="chart-frame chart-frame--visible" />

        <!-- Symbol text in top right corner of chart (inside SVG) -->
        @if (selected(); as sym) {
        <text class="chart-symbol" [attr.x]="viewW - padRight - 10" [attr.y]="padTop + 25" text-anchor="end"
            font-size="20" font-weight="bold" fill="#60a5fa">
            {{ sym }}
        </text>
        }

        <!-- Vertical grid lines (one per bar) -->
        @for (bar of bars(); track bar.t; let i = $index) {
        <line class="v-grid" [attr.x1]="xMid(i)" [attr.x2]="xMid(i)" [attr.y1]="padTop" [attr.y2]="viewH - padBottom" />
        }

        <!-- Time labels using xTicks computed signal -->
        @for (tick of xTicks(); track tick.x) {
        <text class="t-label" [attr.x]="tick.x" [attr.y]="viewH - padBottom + 20">
            {{ tick.label }}
        </text>
        }

        <!-- Candle wicks -->
        @for (bar of bars(); track bar.t; let i = $index) {
        <line [attr.x1]="xMid(i)" [attr.x2]="xMid(i)" [attr.y1]="y(bar.h)" [attr.y2]="y(bar.l)"
            [attr.stroke]="bar.c >= bar.o ? 'var(--candle-up-wick)' : 'var(--candle-down-wick)'" stroke-width="1" />
        }

        <!-- Candle bodies -->
        @for (bar of bars(); track bar.t; let i = $index) {
        <rect [attr.x]="xBody(i)" [attr.y]="y(math.max(bar.o, bar.c))" [attr.width]="getBodyWidth()"
            [attr.height]="math.max(1, math.abs(y(bar.o) - y(bar.c)))"
            [attr.fill]="bar.c >= bar.o ? 'var(--candle-up-body)' : 'var(--candle-down-body)'" />
        }

        <!-- Baseline from opening price -->
        @if (bars().length > 0) {
        <line class="baseline" [attr.x1]="padLeft" [attr.x2]="viewW - padRight" [attr.y1]="y(bars()[0].o)"
            [attr.y2]="y(bars()[0].o)" />
        }

        <!-- Live price line and badge -->
        @if (livePrice(); as lp) {
        <!-- Dashed horizontal line -->
        <line class="live-line" [attr.x1]="padLeft" [attr.x2]="viewW - padRight" [attr.y1]="y(lp)" [attr.y2]="y(lp)" />

        <!-- Price badge on the right (LARGER + inside frame) -->
        <g [attr.transform]="'translate(' + (viewW - padRight - 74) + ',' + (y(lp) - 13) + ')'">
            <rect width="72" height="35" rx="8" class="live-badge" />
            <text x="36" y="24" text-anchor="middle" class="live-badge-text">
                {{ lp | number:'1.2-2' }}
            </text>
        </g>
        }

        <!-- Trading signals (BUY/SELL) -->
        @for (signal of tradeSignals(); track signal.type + '-' + signal.barIndex) {
        <!-- Vertical guide line -->
        <line [attr.x1]="xMid(signal.barIndex)" [attr.x2]="xMid(signal.barIndex)" [attr.y1]="padTop"
            [attr.y2]="viewH - padBottom" [attr.stroke]="signal.type === 'BUY' ? '#16a34a' : '#dc2626'"
            class="sig-guide" />

        <!-- Signal badge (LARGER) -->
        <g [attr.transform]="'translate(' + (xMid(signal.barIndex) - 28) + ',' +
        (y(signal.price) + (signal.type === 'BUY' ? 12 : -34)) + ')'">
            <rect width="56" height="35" rx="8" [attr.class]="signal.type === 'BUY' ? 'badge' : 'badge badge--sell'" />
            <text x="28" y="24" text-anchor="middle" class="badge-text">
                {{ signal.type }}
            </text>
        </g>
        }
    </svg>
</section>